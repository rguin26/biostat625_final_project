---
title: "project_report"
output: 
  html_document:
    toc: true
    theme: united
date: "12/17/2021"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
## Working directory (to be set manually)
## To ultimately remove
## setwd("C:/Users/Rudra Guin/Documents/UMich/Biostatistics_625/biostat625_final_project")
```

# Introduction/Motivation

# Preprocessing the data

Before going into analysis and modeling, we first clean up and pre-process the data

```{r}
data <- read.delim(file = 'clinical.tsv', sep = '\t', header = TRUE)
data[data == "\'--"] <- "NULL"
is.na(data) <- data == "NULL"
data <- data[, colSums(is.na(data)) < nrow(data)]
```


Viewing the unique values of the "vital status" target variable option:

```{r}
unique(data$vital_status)
```

We decided to use half of the dataset for survival analysis and the other half of the dataset for machine learning modeling and analysis. We split the dataset in half using a random selection of rows for each.

```{r}
smp_size <- floor(0.5 * nrow(data))
rand_indexes <- sample(seq_len(nrow(data)), size = smp_size)
data_subset_1 <- data[rand_indexes,] # for survival analysis
data_subset_2 <- data[-rand_indexes,] # for machine learning modeling and analysis
```

```{r}
data_subset_2 <- subset(data_subset_2, select = -c(case_id, case_submitter_id))
data_subset_2 <- transform(
  data_subset_2,
  project_id=as.factor(project_id),
  age_at_index=as.numeric(age_at_index),
  age_is_obfuscated=as.factor(age_is_obfuscated),
  cause_of_death=as.factor(cause_of_death),
  days_to_birth=as.numeric(days_to_birth),
  days_to_death=as.numeric(days_to_death),
  ethnicity=as.factor(ethnicity),
  gender=as.factor(gender),
  race=as.factor(race),
  vital_status=as.factor(vital_status),
  year_of_birth=as.numeric(year_of_birth),
  year_of_death=as.numeric(year_of_death),
  age_at_diagnosis=as.numeric(age_at_diagnosis),
  ajcc_pathologic_stage=as.factor(ajcc_pathologic_stage),
  ajcc_staging_system_edition=as.factor(ajcc_staging_system_edition),
  classification_of_tumor=as.factor(classification_of_tumor),
  days_to_diagnosis=as.numeric(days_to_diagnosis),
  days_to_last_follow_up=as.numeric(days_to_last_follow_up),
  days_to_last_known_disease_status=as.numeric(days_to_last_known_disease_status),
  days_to_recurrence=as.numeric(days_to_recurrence),
  icd_10_code=as.factor(icd_10_code),
  last_known_disease_status=as.factor(last_known_disease_status),
  metastasis_at_diagnosis=as.factor(metastasis_at_diagnosis),
  morphology=as.factor(morphology),
  primary_diagnosis=as.factor(primary_diagnosis),
  prior_malignancy=as.factor(prior_malignancy),
  prior_treatment=as.factor(prior_treatment),
  progression_or_recurrence=as.factor(progression_or_recurrence),
  residual_disease=as.factor(residual_disease),
  site_of_resection_or_biopsy=as.factor(site_of_resection_or_biopsy),
  synchronous_malignancy=as.factor(synchronous_malignancy),
  tissue_or_organ_of_origin=as.factor(tissue_or_organ_of_origin),
  tumor_grade=as.factor(tumor_grade),
  year_of_diagnosis=as.numeric(year_of_diagnosis),
  days_to_treatment_end=as.numeric(days_to_treatment_end),
  days_to_treatment_start=as.numeric(days_to_treatment_start),
  initial_disease_status=as.factor(initial_disease_status),
  therapeutic_agents=as.factor(therapeutic_agents),
  treatment_anatomic_site=as.factor(treatment_anatomic_site),
  treatment_intent_type=as.factor(treatment_intent_type),
  treatment_or_therapy=as.factor(treatment_or_therapy),
  treatment_outcome=as.factor(treatment_outcome),
  treatment_type=as.factor(treatment_type)
 )
  
summary(data_subset_2)
```

```{r}
# remove variables with more than 1000 missing values
data_subset_2 <- subset(data_subset_2, select = -c(age_is_obfuscated, ajcc_pathologic_stage, ajcc_staging_system_edition, days_to_diagnosis, metastasis_at_diagnosis, treatment_anatomic_site, treatment_outcome))

# remove variables with only 1 level
data_subset_2 <- subset(data_subset_2, select = -c(cause_of_death, year_of_death, days_to_last_known_disease_status, days_to_recurrence, residual_disease, days_to_treatment_end, days_to_treatment_start, initial_disease_status, therapeutic_agents, treatment_intent_type))
```

## Data Implementation
```{r}
library(mice)
data_subset_2_imp <- mice(data_subset_2, m=15, method = "sample")
data_subset_rf = complete(data_subset_2_imp)
# Remove variables with missing values after the implementation
data_subset_rf <- subset(data_subset_rf, select = -c(age_at_index, age_at_diagnosis, classification_of_tumor))
```


# Analysis

## Survival Analysis

We first conducted some survival analysis on the half of the initial preprocessed dataset.

```{r}

```

## Machine Learning Modeling and Analysis

We also performed some machine learning modeling and evaluated the effectiveness of the models' prediction power of the vital status of certain patients.

Random Forest:
```{r}
library(randomForest)
library(caTools)
library(caret)
sample <- sample.split(data_subset_rf$vital_status, SplitRatio = .75)
train_rf <- subset(data_subset_rf, sample == TRUE)
test_rf  <- subset(data_subset_rf, sample == FALSE)
#dim(train_rf)
#dim(test_rf)
rf <- randomForest(vital_status ~ ., data=train_rf, na.action = na.omit)
```
Results:
```{r}
p1 <- predict(rf, train_rf)
confusionMatrix(p1, train_rf$vital_status)
p2 <- predict(rf, test_rf)
confusionMatrix(p2, test_rf$vital_status)
```

Neural Network:
- still in early stages
```{r}
library(neuralnet)
library(caTools)
library(caret)
sample <- sample.split(data_subset_rf$vital_status, SplitRatio = .75)
train_nn <- subset(data_subset_rf, sample == TRUE)
test_nn  <- subset(data_subset_rf, sample == FALSE)

## https://www.rdocumentation.org/packages/neuralnet/versions/1.44.2/topics/neuralnet
# Multiclass classification
# rf <- randomForest(vital_status ~ ., data=train_rf, na.action = na.omit)
# nn <- neuralnet(Species ~ Petal.Length + Petal.Width, iris, linear.output = FALSE)
nn <- neuralnet(vital_status ~ ., data = train_nn)
```

K-Nearest Neighbors (K-NN):
- still in early stages
```{r}
library(class)
sample <- sample.split(data_subset_rf$vital_status, SplitRatio = .75)
train_k_nn <- subset(data_subset_rf, sample == TRUE)
test_k_nn  <- subset(data_subset_rf, sample == FALSE)
knn(train_k_nn, test_k_nn, cl = 4, k = 25)#, l = 0, prob = FALSE, use.all = TRUE)
```

# Conclusion
